<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediaProof | Enterprise</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #000; color: #fff; font-family: 'Space Grotesk', sans-serif; overflow: hidden; }
        #root { width: 100%; height: 100vh; }
        .glass-panel { background: rgba(10, 10, 15, 0.65); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .neon-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.4); }
        ::-webkit-scrollbar { width: 6px; background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        #bsod { display: none; position: fixed; inset: 0; background: #0000AA; color: #fff; font-family: monospace; padding: 40px; z-index: 10000; font-size: 20px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="bsod"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('bsod').style.display = 'block';
            document.getElementById('bsod').innerHTML = `<h1>SYSTEM HALTED</h1><p>Error: ${msg}</p><button onclick="location.reload()" style="background:white; color:blue; padding:10px; border:none; margin-top:20px; cursor:pointer;">RESTART SYSTEM</button>`;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { motion, AnimatePresence } = window.Motion;
        
        // ==========================================
        // ⚠️ CONFIGURATION (UPDATE THIS) ⚠️
        // ==========================================
        const CONFIG = {
            CLOUDINARY_URL: "https://api.cloudinary.com/v1_1/dphicbaf2/auto/upload",
            UPLOAD_PRESET: "yhqlojie",
            // YOUR CLOUDFLARE WORKER URL
            ORCHESTRATOR_URL: "https://mediaproofai.mediaproofai.workers.dev/",
            GOOGLE_CLIENT_ID: "YOUR_GOOGLE_ID"
        };

        const PLANS = {
            FREE: { name: "Observer", limit: 2, price: "Free", color: "text-slate-400" },
            PRO: { name: "God Mode", limit: 9999, price: "$9.99", color: "text-cyan-400" }
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('landing');
            const [scanStatus, setScanStatus] = useState({ log: [], progress: 0 });
            const [report, setReport] = useState(null);
            const [showPricing, setShowPricing] = useState(false);
            const [debugMode, setDebugMode] = useState(false);

            useEffect(() => {
                const u = localStorage.getItem('mediaproof_user');
                if (u) setUser(JSON.parse(u));
                if (window.lucide) window.lucide.createIcons();
            }, []);

            const login = (tier) => {
                const u = { name: 'Verified Agent', plan: PLANS[tier], credits: PLANS[tier].limit };
                setUser(u);
                localStorage.setItem('mediaproof_user', JSON.stringify(u));
                setView('dashboard');
            };

            const runScan = async (e) => {
                const f = e.target.files[0];
                if (!f) return;
                
                setView('scanning');
                setScanStatus({ log: ['INITIALIZING KERNEL...'], progress: 10 });

                try {
                    // 1. Upload
                    setScanStatus(prev => ({ log: [...prev.log, 'UPLOADING EVIDENCE...'], progress: 30 }));
                    const fd = new FormData();
                    fd.append('file', f);
                    fd.append('upload_preset', CONFIG.UPLOAD_PRESET);
                    
                    const upRes = await fetch(CONFIG.CLOUDINARY_URL, { method: 'POST', body: fd });
                    if (!upRes.ok) throw new Error("Upload Failed");
                    const upData = await upRes.json();
                    
                    // 2. Scan
                    setScanStatus(prev => ({ log: [...prev.log, 'RUNNING HYBRID ANALYSIS...'], progress: 60 }));
                    
                    let type = 'document';
                    if (f.type.startsWith('image')) type = 'image';
                    else if (f.type.startsWith('audio')) type = 'audio';
                    else if (f.type.startsWith('video')) type = 'video';

                    const orchRes = await fetch(CONFIG.ORCHESTRATOR_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ mediaUrl: upData.secure_url, type })
                    });
                    
                    if (!orchRes.ok) throw new Error("Backend Connection Failed");
                    const data = await orchRes.json();
                    
                    setReport(data);
                    setScanStatus(prev => ({ log: [...prev.log, 'COMPLETE.'], progress: 100 }));
                    
                    const u = { ...user, credits: user.credits - 1 };
                    setUser(u);
                    localStorage.setItem('mediaproof_user', JSON.stringify(u));

                    setTimeout(() => setView('results'), 800);
                } catch (err) {
                    alert("Scan Error: " + err.message);
                    setView('dashboard');
                }
            };

            // *** CRITICAL PATCH: CRASH DETECTOR ***
            const getParsedResults = () => {
                if (!report) return {};
                const r = report;
                
                let mode = "VISUAL";
                let prob = 0;
                let method = "N/A";
                let physics = "N/A";
                let signature = "N/A";
                let isError = false;

                try {
                    // 1. DETECT SERVICE CRASHES (The "Fail Open" Fix)
                    if (r.details?.document?.error || r.details?.forensic?.error || r.details?.video?.error) {
                         return {
                            mode: "SYSTEM_ALERT",
                            prob: "100.0", // Force Max Risk
                            method: "SERVICE_FAILURE",
                            physics: "UNSUPPORTED_FILE",
                            signature: "POTENTIAL_OBFUSCATION",
                            isError: true
                         };
                    }

                    // 2. NORMAL PARSING
                    if (r.media_type === 'audio') {
                        mode = "AUDIO";
                        const aud = r.details?.audio || {};
                        prob = (aud.voice_integrity?.cloning_probability * 100 || 0).toFixed(1);
                        method = aud.voice_integrity?.method || "SIGNAL_PHYSICS";
                        physics = aud.signal_analysis?.frequency_cutoff || "N/A";
                    } else if (r.media_type === 'video') {
                        mode = "VIDEO";
                        const vid = r.details?.video || {};
                        const img = r.details?.forensic || {}; 
                        
                        const vidScore = vid.verdict?.aiProbability || 0;
                        const imgScore = img.verdict?.aiProbability || 0;
                        
                        prob = (Math.max(vidScore, imgScore) * 100).toFixed(1);
                        method = vidScore > imgScore ? (vid.verdict?.method || "CONTAINER_PHYSICS") : "FRAME_ENTROPY_SCAN";
                        physics = vid.temporal_analysis?.compression_lineage || "N/A";
                        signature = vid.temporal_analysis?.sync_anomaly === "HIGH_JITTER" ? "JITTER_DETECTED" : "STABLE";
                    } else if (r.media_type === 'document') {
                        // Document logic (if not crashed)
                        mode = "DOCUMENT";
                        prob = "0.0"; // Placeholder if successful
                        method = "METADATA_SCAN";
                    } else {
                        const img = r.details?.forensic || {};
                        prob = (img.verdict?.aiProbability * 100 || 0).toFixed(1);
                        method = img.verdict?.detection_method || "NEURAL_NET";
                        physics = img.details?.noiseAnalysis?.verdict || "N/A";
                        signature = r.details?.metadata?.deviceFingerprint?.make !== "Unknown" ? "HARDWARE_VERIFIED" : "STRIPPED";
                    }
                    
                    // Sanity check
                    if (prob === "0.0" && signature.includes("Software")) prob = "65.0";

                } catch (e) { console.error(e); }

                return { mode, prob, method, physics, signature, isError };
            };

            const parsed = getParsedResults();
            const osint = report?.details?.internet?.footprintAnalysis;

            // Determine final Authenticity Score (Override if error)
            const finalScore = parsed.isError ? 0 : Math.max(0, 100 - parseFloat(parsed.prob));
            const riskLabel = parsed.isError ? "SYSTEM FAILURE" : (parseFloat(parsed.prob) > 50 ? "CRITICAL RISK" : "VERIFIED SAFE");

            return (
                <div className="h-full flex flex-col relative">
                    {/* BACKGROUND */}
                    <div className="fixed inset-0 z-0 opacity-20 pointer-events-none" 
                        style={{
                            backgroundImage: 'linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px)',
                            backgroundSize: '40px 40px',
                            maskImage: 'radial-gradient(circle at center, black 40%, transparent 80%)'
                        }} 
                    />

                    {/* NAVBAR */}
                    <nav className="h-16 border-b border-white/10 bg-black/80 flex items-center justify-between px-6 sticky top-0 z-50 backdrop-blur-md">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('landing')}>
                            <i data-lucide="shield" className="text-cyan-400"></i>
                            <span className="font-bold tracking-tight">MediaProof</span>
                        </div>
                        {user && <div className="text-xs font-mono text-cyan-400 border border-cyan-400/30 px-3 py-1 rounded bg-cyan-400/10">{user.credits} CR</div>}
                    </nav>

                    {/* CONTENT */}
                    <main className="flex-1 overflow-y-auto relative">
                        <AnimatePresence mode="wait">
                            
                            {/* LANDING */}
                            {view === 'landing' && (
                                <motion.div key="landing" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} className="min-h-screen flex flex-col items-center justify-center relative p-6">
                                    <div className="text-center max-w-4xl z-10">
                                        <div className="inline-block px-4 py-1 mb-6 rounded-full border border-cyan-500/30 bg-cyan-500/10 text-cyan-400 text-xs font-mono tracking-[0.3em]">ENTERPRISE SUITE v2.0</div>
                                        <h1 className="text-6xl md:text-8xl font-black tracking-tighter mb-6 bg-clip-text text-transparent bg-gradient-to-b from-white to-slate-600">TRUTH.<br/>VERIFIED.</h1>
                                        <p className="text-xl text-slate-400 mb-10 max-w-2xl mx-auto">Analyze Deepfakes and AI Media with military-grade forensics.</p>
                                        <div className="flex gap-4 justify-center">
                                            <button onClick={() => setView('auth')} className="px-8 py-4 bg-cyan-400 text-black font-bold hover:scale-105 transition-transform shadow-[0_0_40px_rgba(6,182,212,0.4)]">START SCAN</button>
                                            <button onClick={() => setShowPricing(true)} className="px-8 py-4 border border-white/20 hover:bg-white/10 font-bold">PLANS</button>
                                        </div>
                                    </div>
                                </motion.div>
                            )}

                            {/* AUTH */}
                            {view === 'auth' && (
                                <motion.div key="auth" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} className="h-full flex items-center justify-center p-6">
                                    <div className="glass-panel p-10 max-w-md w-full border-t-4 border-cyan-400 text-center">
                                        <i data-lucide="lock" className="w-12 h-12 text-cyan-400 mx-auto mb-4"></i>
                                        <h2 className="text-2xl font-bold mb-8">Secure Access</h2>
                                        <button onClick={() => login('FREE')} className="w-full py-4 bg-white/10 hover:bg-white/20 border border-white/10 rounded font-bold mb-4">CONTINUE AS GUEST</button>
                                    </div>
                                </motion.div>
                            )}

                            {/* DASHBOARD */}
                            {view === 'dashboard' && (
                                <motion.div key="dashboard" initial={{opacity:0}} animate={{opacity:1}} className="h-full flex flex-col items-center justify-center p-6">
                                    <h2 className="text-4xl font-bold mb-4">Upload Evidence</h2>
                                    <p className="text-slate-400 mb-10">JPG, PNG, MP4, MP3, PDF</p>
                                    <label className="glass-panel w-full max-w-3xl h-80 border-2 border-dashed border-white/10 hover:border-cyan-400 hover:bg-cyan-400/5 transition-all cursor-pointer flex flex-col items-center justify-center group rounded-2xl">
                                        <i data-lucide="upload" className="w-16 h-16 text-slate-600 group-hover:text-cyan-400 mb-6 transition-colors"></i>
                                        <span className="text-xl font-bold group-hover:text-white">DRAG & DROP FILE</span>
                                        <input type="file" className="hidden" onChange={runScan} />
                                    </label>
                                </motion.div>
                            )}

                            {/* SCANNING */}
                            {view === 'scanning' && (
                                <motion.div key="scanning" className="h-full flex flex-col items-center justify-center bg-black">
                                    <div className="w-64 h-64 relative flex items-center justify-center mb-10">
                                        <div className="absolute inset-0 border-4 border-cyan-900 rounded-full"></div>
                                        <div className="absolute inset-0 border-t-4 border-cyan-400 rounded-full animate-spin"></div>
                                        <i data-lucide="fingerprint" className="w-16 h-16 text-white animate-pulse"></i>
                                    </div>
                                    <div className="font-mono text-cyan-400 text-xl tracking-widest mb-4">PROCESSING</div>
                                    <div className="h-1 w-64 bg-slate-800 rounded overflow-hidden mb-4">
                                        <motion.div className="h-full bg-cyan-400" initial={{width:0}} animate={{width: `${scanStatus.progress}%`}} />
                                    </div>
                                    <div className="font-mono text-xs text-slate-500">{scanStatus.log[scanStatus.log.length-1]}</div>
                                </motion.div>
                            )}

                            {/* RESULTS */}
                            {view === 'results' && report && (
                                <motion.div key="results" initial={{opacity:0, y:20}} animate={{opacity:1, y:0}} className="p-6 md:p-12 pb-32">
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        
                                        {/* SCORE CARD */}
                                        <div className="glass-panel p-8 border-t-4 border-cyan-400 relative overflow-hidden flex flex-col justify-between h-96">
                                            <div>
                                                <div className="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">Authenticity Score</div>
                                                <div className={`text-9xl font-black tracking-tighter ${finalScore < 50 ? 'text-red-500 neon-text' : 'text-green-400 neon-text'}`}>
                                                    {finalScore.toFixed(0)}
                                                </div>
                                                <div className={`inline-block px-3 py-1 rounded text-xs font-bold mt-2 ${finalScore < 50 ? 'bg-red-900/30 text-red-400' : 'bg-green-900/30 text-green-400'}`}>
                                                    {riskLabel}
                                                </div>
                                            </div>
                                            <div className="pt-6 border-t border-white/10">
                                                <p className="text-sm leading-relaxed text-slate-300">
                                                    {parsed.isError ? "Unable to verify file integrity. Core forensic services crashed or the file type is obfuscated." : (report.risk?.executiveSummary || "Analysis complete.")}
                                                </p>
                                            </div>
                                        </div>

                                        {/* METRICS */}
                                        <div className="lg:col-span-2 space-y-6">
                                            <div className="glass-panel p-6">
                                                <h3 className="text-lg font-bold mb-6 text-cyan-400 flex items-center gap-2">
                                                    <i data-lucide="scan-line" className="w-5 h-5"></i> 
                                                    {parsed.mode} VECTOR ANALYSIS
                                                </h3>
                                                <div className="grid md:grid-cols-2 gap-4">
                                                    <div className="p-4 bg-cyan-400/5 border border-cyan-400/30 rounded">
                                                        <div className="text-[10px] font-bold text-slate-500 mb-1">PROBABILITY</div>
                                                        <div className="text-xl font-mono font-bold text-cyan-400">{parsed.prob}%</div>
                                                    </div>
                                                    <div className="p-4 bg-white/5 border border-white/10 rounded">
                                                        <div className="text-[10px] font-bold text-slate-500 mb-1">METHOD</div>
                                                        <div className="text-xl font-mono font-bold text-white truncate">{parsed.method}</div>
                                                    </div>
                                                    <div className="p-4 bg-white/5 border border-white/10 rounded">
                                                        <div className="text-[10px] font-bold text-slate-500 mb-1">PHYSICS</div>
                                                        <div className="text-xl font-mono font-bold text-white truncate">{parsed.physics}</div>
                                                    </div>
                                                    <div className="p-4 bg-white/5 border border-white/10 rounded">
                                                        <div className="text-[10px] font-bold text-slate-500 mb-1">SIGNATURE</div>
                                                        <div className="text-xl font-mono font-bold text-white truncate">{parsed.signature}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="glass-panel p-6">
                                                <h3 className="text-lg font-bold mb-6 text-purple-400 flex items-center gap-2"><i data-lucide="globe" className="w-5 h-5"></i> Global Origin Trace</h3>
                                                <div className="grid md:grid-cols-2 gap-4 mb-6">
                                                    <div className="p-4 bg-white/5 border border-white/10 rounded">
                                                        <div className="text-[10px] font-bold text-slate-500 mb-1">GENERATOR</div>
                                                        <div className="text-xl font-mono font-bold text-white">{osint?.ai_generator_name || "Unknown"}</div>
                                                    </div>
                                                    <div className="p-4 bg-white/5 border border-white/10 rounded">
                                                        <div className="text-[10px] font-bold text-slate-500 mb-1">MATCHES</div>
                                                        <div className="text-xl font-mono font-bold text-white">{osint?.totalMatches || 0}</div>
                                                    </div>
                                                </div>
                                                
                                                {osint?.matches?.length > 0 ? (
                                                    <div className="space-y-2 max-h-40 overflow-y-auto pr-2">
                                                        {osint.matches.map((m, i) => (
                                                            <a key={i} href={m.url} target="_blank" className="flex items-center justify-between p-3 bg-white/5 hover:bg-white/10 rounded group">
                                                                <div className="truncate text-sm font-bold text-cyan-400 group-hover:underline">{m.source_name}</div>
                                                                <div className="text-xs text-slate-400">{m.posted_time}</div>
                                                            </a>
                                                        ))}
                                                    </div>
                                                ) : <div className="text-center text-slate-500 text-sm p-4">No public matches found.</div>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-8 flex gap-4">
                                        <button onClick={() => setView('dashboard')} className="px-6 py-3 bg-white/10 hover:bg-white/20 rounded font-bold text-sm">START NEW SCAN</button>
                                        <button onClick={() => setDebugMode(!debugMode)} className="px-6 py-3 border border-white/10 hover:text-red-500 rounded font-bold text-sm">DEBUG</button>
                                    </div>
                                    
                                    {/* DEBUG PANEL */}
                                    {debugMode && (
                                        <div className="mt-8 p-6 bg-black border border-red-500 font-mono text-xs text-green-400 overflow-auto max-h-96">
                                            <pre>{JSON.stringify(report, null, 2)}</pre>
                                        </div>
                                    )}
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </main>

                    {showPricing && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
                            <div className="w-full max-w-4xl relative p-8 glass-panel">
                                <button onClick={() => setShowPricing(false)} className="absolute top-4 right-4 text-white hover:text-cyan-400"><i data-lucide="x"></i></button>
                                <h2 className="text-3xl font-bold text-center mb-8">Clearance Levels</h2>
                                <div className="grid md:grid-cols-2 gap-6">
                                    {Object.values(PLANS).map((plan, i) => (
                                        <div key={i} className="p-6 border border-white/10 rounded flex flex-col items-center text-center hover:border-cyan-400 transition-colors">
                                            <h3 className={`text-xl font-bold mb-2 ${plan.color}`}>{plan.name}</h3>
                                            <div className="text-3xl font-mono font-bold mb-4">{plan.price}</div>
                                            <button className="px-6 py-2 bg-white/10 rounded font-bold text-sm hover:bg-white/20">SELECT</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
